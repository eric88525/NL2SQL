<!DOCTYPE html>
<html lang="en">

<head>
  <title>NL2SQL</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2020.3.1118/styles/kendo.common.min.css" />
  <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2020.3.1118/styles/kendo.blueopal.min.css" />
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet" />
  <script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
</head>

<body>
  <div id="floatWindow">
    <div class="container">
      <div class="row justify-content-end" id="floatDemoTable">
      </div>
    </div>
  </div>
  <div class="container p-3 my-3 bg-dark text-white">
    <h1>Natual language to SQL command</h1>
  </div>

  <div class="container ">
    <h2>Select table</h2>
    <br>
    <div class="row">
      <div class="col">
        <button id="tableSelector" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
          Table list
        </button>
        <div class="dropdown-menu" id="tableList">
          <a class="dropdown-item" href="#">Link 1</a>

        </div>
      </div>
      <div class="col-8">
        <div class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Please input query" aria-label="Please input query" aria-describedby="basic-addon2"
            id="questionText">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" id="transSql">進行轉換</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <br>

  <div class="container">
    <div class="row">
      <div class="col">
        <h2>Table</h2>
        <p id="tableName"> </p>
      </div>
      <div class="col-8">

        <div class="input-group ">
          <textarea class="form-control" aria-label="With textarea" id="resultText"></textarea>

          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" id="runSql"> Execute SQL command</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container" id="demoTable">
  </div>

</body>

<script src="{{ url_for('static', filename='js/kendo.all.min.js') }}"></script>

<script type="text/javascript">

  $(document).ready(function () {
    // create float window
    $("#floatWindow").kendoWindow({
      width: '1000px',
      height: 'auto',
      title: "SQL result",
      visible: false,
      modal: true,
      actions: [
        "Close"
      ],
    }).data("kendoWindow").center();

    createDropDownList('http://127.0.0.1:5000/api/tablelist');

    // select table from database
    $(".tableItem").click(function () {
      // display table name
      $("#tableName").text(this.id);
      tableId = this.id;
      var columns = []
      var datas = []
      $.ajax({
        type: "post",
        url: 'http://127.0.0.1:5000/api/table',
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify({
          table_name: tableId
        }),
        async: false,
        success: function (data) {
          columns = data.columns,
            datas = data.datas
        }
      });
      table = createTable(columns, datas);
      $("#demoTable table").remove();
      $('#demoTable').append(table);
    })

    function createDropDownList(url) {
      content = []
      $.ajax({
        type: "get",
        url: url,
        dataType: "json",
        async: false,
        success: function (data) {
          content = data;
        }
      });
      $("#tableList a").remove();
      content.forEach(element => {
        //console.log(element)
        var row = $("<a class='tableItem'   href='#' id='" + element.Value + "'></a>").addClass("dropdown-item").text(element.Text)
        $("#tableList").append(row)
      });
    }

    // create table object
    function createTable(columns, datas) {

      var headers = [];

      var thead = $("<thead></thead>").addClass('thead-dark ');
      var table = $('<table></table>').addClass('table table-striped');
      var body = $('<tbody></tbody>');

      tr = $('<tr></tr>');
      columns.forEach(element => {
        var row = $("<th></th>").text(element.Name);
        tr.append(row);
        headers.push(element.Index)
      });
      thead.append(tr)

      datas.forEach(element => {
        var row = $("<tr></tr>");
        headers.forEach(key => {
          var rowData = $('<td></td>').addClass('bar').text(element[key]);
          row.append(rowData);
        });
        body.append(row);
      });

      table.append(thead);
      table.append(body);
      return table
    }
    // post query to backend and show result on resultText
    $("#transSql").click(function () {
      $.ajax({
        type: "post",
        url: 'http://127.0.0.1:5000/api/sql',
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify({
          question: $("#questionText").val(),
          table_name: $("#tableName").text()
        }),
        async: false,
        success: function (data) {
          $("#resultText").val(data)
        }
      });

    });
    // execute SQL command and show table
    $("#runSql").click(function () {
      console.log('run sql...')
      var columns = [];
      var datas = [];
      $.ajax({
        type: "post",
        url: 'http://127.0.0.1:5000/api/runsql',
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify({
          sql: $("#resultText").val()
        }),
        async: false,
        success: function (data) {
          columns = data.columns,
            datas = data.datas
        }
      });
      table = createTable(columns, datas);

      $("#floatDemoTable table").remove();
      $('#floatDemoTable').append(table);

      $("#floatWindow").data("kendoWindow").open();
    });
  });
</script>
</html>